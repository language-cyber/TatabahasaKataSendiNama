<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuasai Kata Sendi Nama - Edisi Diraja (DBP Style)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,700;0,800;1,700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: #fcfcfc; 
            color: #000; 
            overflow-x: hidden; 
            scroll-behavior: smooth;
        }

        .serif-font { font-family: 'Playfair Display', serif; }

        /* --- Tipografi --- */
        .text-giant-header { font-size: clamp(4rem, 15vw, 8rem); line-height: 1; font-weight: 800; letter-spacing: -0.04em; text-align: center; }
        .text-giant-body { font-size: clamp(2.2rem, 7vw, 4rem); line-height: 1.2; font-weight: 700; text-align: center; }
        .text-dual { font-size: clamp(1.5rem, 4vw, 2.5rem); color: #94a3b8; font-style: italic; font-weight: 500; text-align: center; }

        /* --- Layout --- */
        .view-section { display: none; min-height: 100vh; width: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view-section.active { display: flex; }
        .page { display: none; animation: fadeIn 0.4s ease-out; width: 100%; text-align: center; padding: 2rem; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes shakeError { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        
        .shake { animation: shakeError 0.4s ease-in-out; border-color: #ef4444 !important; }

        /* --- UI Components --- */
        .objective-box {
            position: fixed; top: 30px; left: 40px; background: #000; color: #fff;
            padding: 10px 30px; border-radius: 4px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.1em; z-index: 100; display: flex; gap: 12px; align-items: center;
        }
        
        .input-flat {
            border-bottom: 8px solid #e2e8f0; outline: none; padding: 0 15px;
            text-align: center; font-weight: 800; color: #4f46e5; width: 100%;
            max-width: 900px; background: transparent; font-size: clamp(1.5rem, 5vw, 3rem); transition: all 0.3s;
        }
        .input-flat:focus { border-color: #000; }

        /* --- Chat Style --- */
        .chat-container {
            width: 100%; max-width: 800px; height: 550px; background: #e5ddd5;
            border: 4px solid #000; border-radius: 24px; overflow: hidden;
            display: flex; flex-direction: column; box-shadow: 12px 12px 0px rgba(0,0,0,0.1);
        }
        .chat-bubble {
            max-width: 75%; padding: 14px 18px; border-radius: 18px; margin-bottom: 10px;
            font-size: 1.15rem; line-height: 1.4; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .bubble-left { background: #fff; border-bottom-left-radius: 2px; align-self: flex-start; }
        .bubble-right { background: #dcf8c6; border-bottom-right-radius: 2px; align-self: flex-end; }
        
        .monitor-card {
            background: #fff; border: 2px solid #000; border-radius: 16px; padding: 20px;
            margin-bottom: 15px; box-shadow: 6px 6px 0px rgba(0,0,0,0.1); text-align: left;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .mastery-star { width: 45px; height: 45px; border: 3px solid #000; display: flex; align-items: center; justify-content: center; background: #fff; transition: all 0.3s; font-size: 1.5rem; }
        .mastery-star.filled { background: #facc15; transform: scale(1.1) rotate(10deg); color: #000; }
        
        /* Dropdown Styling */
        select.ksn-select {
            appearance: none; background: #f1f5f9; border: 4px solid #000; border-radius: 12px;
            padding: 5px 20px; font-weight: 800; color: #4f46e5; cursor: pointer; outline: none;
            transition: all 0.2s; text-align: center;
        }
        select.ksn-select:focus { background: #fff; border-color: #4f46e5; }
        select.ksn-select.correct { border-color: #22c55e; color: #22c55e; background: #f0fdf4; pointer-events: none; }
        
        .key-tip {
            position: fixed; bottom: 30px; right: 30px; font-size: 0.8rem;
            color: #94a3b8; font-weight: 800; text-transform: uppercase; z-index: 200;
            background: rgba(255,255,255,0.8); padding: 5px 10px; border-radius: 8px; backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <div class="fixed top-0 left-0 h-2 bg-gray-100 w-full z-[200]">
        <div id="progressFill" class="h-full bg-black transition-all duration-500" style="width: 0%"></div>
    </div>

    <div class="objective-box">
        <span class="text-indigo-600">Objektif:</span>
        <span id="currentObjective">Memulakan Sesi</span>
    </div>

    <div id="keyTipMsg" class="key-tip hidden md:block">F: Fullscreen | ‚Üê ‚Üí : Navigasi | Scroll: Slide</div>

    <!-- LANDING VIEW -->
    <section id="view-landing" class="view-section active">
        <h1 class="text-giant-header serif-font italic mb-12">Kata Sendi<br>Nama.</h1>
        <div class="w-full max-w-md flex flex-col items-center">
            <input type="text" id="studentName" class="input-flat text-2xl mb-8 uppercase" placeholder="NAMA PENUH ANDA">
            <div class="grid grid-cols-2 gap-4 w-full">
                <button onclick="startApp('teacher')" class="p-8 border-4 border-black font-black uppercase text-sm hover:bg-black hover:text-white transition">Mod Guru</button>
                <button onclick="startApp('student')" class="p-8 border-4 border-black font-black uppercase text-sm hover:bg-black hover:text-white transition">Mod Pelajar</button>
            </div>
        </div>
    </section>

    <!-- TEACHER VIEW -->
    <section id="view-teacher" class="view-section w-full bg-[#f8fafc]">
        <div class="fixed top-[100px] left-10 flex flex-col gap-3 z-[101]">
            <button onclick="jumpToMonitor()" class="bg-[#075e54] text-white px-6 py-3 rounded-full text-xs font-black shadow-lg hover:bg-black transition flex items-center gap-2">
                <i data-lucide="monitor" class="w-4 h-4"></i> LIVE MONITOR
            </button>
            <button onclick="hardResetData()" class="bg-red-600 text-white px-6 py-3 rounded-full text-[10px] font-black shadow-lg hover:bg-black transition flex items-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i> RESET KELAS
            </button>
        </div>

        <div id="teacherContainer" class="w-full relative px-10">
            <!-- Slide 1: Tajuk -->
            <div class="page active" id="tp1" data-obj="Pengenalan Topik">
                <h1 class="text-giant-header">Kata Sendi Nama</h1>
            </div>

            <!-- Slide 2: Do Now (Aktiviti Permulaan) -->
            <div class="page" id="tp2" data-obj="Aktiviti Permulaan (Do Now)">
                <div class="flex flex-col items-center justify-center mt-12 px-6">
                    <span class="text-4xl font-black text-red-500 mb-8 tracking-widest uppercase bg-red-100 px-6 py-2 rounded-full">Aktiviti Permulaan</span>
                    <p class="text-giant-body">Bina satu ayat menggunakan <strong>SEKOLAH</strong> dan <strong>KE</strong>.</p>
                    <p class="text-dual mt-8">Build one sentence using 'School' and 'To'.</p>
                    <div class="mt-16 w-full max-w-5xl border-b-8 border-slate-200 py-8 text-center text-5xl text-slate-300 italic font-medium">
                        Sila tulis pada buku nota anda.
                    </div>
                </div>
            </div>

            <!-- Slide Monitor (Dipindah sementara ke bawah oleh JS nanti) -->
            <div class="page" id="tpLast" data-obj="Monitor Live Feed">
                <div class="w-full max-w-7xl h-[85vh] bg-[#f1f5f9] border-4 border-black mx-auto rounded-3xl overflow-hidden flex flex-col shadow-[12px_12px_0px_#000]">
                    <div class="bg-black p-6 flex items-center justify-between text-white">
                        <div class="flex items-center gap-4">
                            <i data-lucide="activity" class="w-8 h-8 text-green-400"></i>
                            <div>
                                <h3 class="font-bold text-xl uppercase tracking-widest">Radar Guru (Live)</h3>
                                <p class="text-xs text-gray-400" id="lastSync">Bersedia untuk menyegerak...</p>
                            </div>
                        </div>
                        <div id="connectionDot" class="w-4 h-4 rounded-full bg-red-500 animate-pulse"></div>
                    </div>
                    <!-- Grid Pelajar -->
                    <div id="liveGallery" class="flex-1 p-8 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="text-center w-full col-span-full text-slate-400 font-bold mt-10">Menunggu data pelajar...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="fixed bottom-10 flex gap-8 font-black text-2xl uppercase z-[101]">
            <button id="prevBtnT" onclick="changeTeacherPage(-1)">‚Üê Undur</button>
            <span id="teacherIndicator">01 / 15</span>
            <button id="nextBtnT" onclick="changeTeacherPage(1)">Maju ‚Üí</button>
        </div>
    </section>

    <!-- STUDENT VIEW -->
    <section id="view-student" class="view-section p-8 w-full">
        <div class="objective-box">üéØ <span id="studentPhaseTitle">Fasa 2: Latihan Pengukuhan</span></div>
        
        <div id="studentContainer" class="w-full max-w-5xl">
            
            <!-- Phase 2: LEGO (5 Soalan) -->
            <div id="phase2" class="phase-container flex flex-col items-center">
                <div class="flex gap-2 mb-8" id="starContainer">
                    <div class="mastery-star" id="star-0">1</div><div class="mastery-star" id="star-1">2</div>
                    <div class="mastery-star" id="star-2">3</div><div class="mastery-star" id="star-3">4</div>
                    <div class="mastery-star" id="star-4">5</div>
                </div>
                
                <h2 class="text-giant-body mb-4" id="p2Title">Latihan 1/5</h2>
                <p class="text-xl text-slate-500 font-bold mb-8 uppercase tracking-widest" id="p2Context">Konteks: Arah & Tujuan</p>
                
                <div id="legoBox" class="bg-white p-12 border-4 border-black w-full shadow-[12px_12px_0px_#000] rounded-2xl transition-all">
                    
                    <div class="flex flex-wrap items-center justify-center gap-4 text-3xl md:text-5xl font-bold leading-relaxed">
                        <span id="sSubject" class="text-slate-800">Ali</span>
                        <span id="sVerb" class="text-slate-800">pergi</span>
                        <select id="sKsn" class="ksn-select" onchange="validateKsn()">
                            <option value="">(Pilih KSN)</option>
                        </select>
                        <span id="sObject" class="text-slate-800">sekolah.</span>
                    </div>

                    <div id="stretchArea" class="hidden mt-12 pt-8 border-t-4 border-dashed border-slate-200">
                        <div class="flex items-center gap-4 justify-center mb-6">
                            <span class="bg-green-100 text-green-700 px-4 py-1 rounded-full text-sm font-black uppercase">Jawapan Tepat!</span>
                        </div>
                        <p class="text-sm font-black uppercase text-indigo-500 mb-4 tracking-widest text-center">Cabaran 'Stretch It' (Terjemahan):</p>
                        <input type="text" id="translationInput" class="input-flat border-black w-full" placeholder="Terjemah ayat di atas ke Bahasa Inggeris...">
                        <div class="text-center mt-8">
                            <button onclick="submitP2Question()" class="bg-black text-white px-10 py-4 font-bold rounded-full hover:scale-105 transition text-xl">HANTAR JAWAPAN & MAJU üöÄ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Phase 3: Sembang Santai -->
            <div id="phase3" class="hidden phase-container flex flex-col items-center">
                <h2 class="text-giant-body mb-8 serif-font">Sembang Santai (Live)</h2>
                <div class="chat-container">
                    <div class="bg-[#075e54] text-white p-4 flex justify-between font-bold">
                        <span>Misi: Bina ayat dengan <span id="currentChatTag" class="text-yellow-300 uppercase">DARI</span></span> 
                        <span id="chatProgressText">1 / 5</span>
                    </div>
                    <div id="chatArea" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4 bg-[url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')]"></div>
                    <div class="bg-white p-4 flex gap-3 border-t-2">
                        <input type="text" id="chatInput" class="flex-1 border-2 rounded-full px-6 py-3 text-lg outline-none focus:border-[#128c7e]" placeholder="Taip ayat anda di sini..." onkeypress="if(event.key==='Enter') handleChatInput()">
                        <button onclick="handleChatInput()" class="bg-[#128c7e] text-white p-3 rounded-full hover:bg-[#075e54] transition"><i data-lucide="send"></i></button>
                    </div>
                </div>
                <button id="btnFinalSubmit" onclick="goToPhase(4)" class="hidden mt-8 bg-black text-white px-12 py-5 font-black uppercase hover:scale-105 transition shadow-xl rounded-full text-xl">Tamat Sesi üèÜ</button>
            </div>

            <!-- Phase 4: Success -->
            <div id="phase4" class="hidden phase-container flex flex-col items-center py-20 text-center">
                <div class="text-9xl mb-8 animate-bounce">üèÜ</div>
                <h2 class="text-giant-header serif-font italic">Terbaik, Boss!</h2>
                <p class="text-2xl font-bold mt-8 text-slate-500 uppercase tracking-widest">Semua tugasan telah direkod dalam radar cikgu.</p>
            </div>
        </div>
    </section>

    <script>
        // ‚ö†Ô∏è PENTING: TUKAR URL INI DENGAN URL GOOGLE APPS SCRIPT YANG BARU DI-DEPLOY!
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYDJu7fYaCha9SgYhQjA7R5AqIFWA-MaVFCPnRTr17fUGEQR6zqN_fB7OhC6uv4mRxBg/exec';
        
        let currentRole = '', studentName = '', tPage = 1, pollingInterval;
        let totalTeacherPages = 2; // Akan dikemaskini oleh initTeacherSlides

        // --- DATA PENERANGAN KSN (Teacher Mode) ---
        const notaKataSendi = [
            { k: "DI", m: "TEMPAT (Statik)", e: "Static Location", f: "lokasi-statik.jpg", p: "Foto seorang pelajar sedang membaca buku di dalam perpustakaan yang tenang, gaya minimalis." },
            { k: "KE", m: "ARAH / TUJUAN", e: "Direction / Destination", f: "destinasi-melaka.jpg", p: "Foto Bangunan Merah Stadthuys di Melaka dengan beca berhias di hadapannya." },
            { k: "DARI", m: "TEMPAT / MASA ASAL", e: "Origin (Place/Time)", f: "titik-mula.jpg", p: "Foto jam loceng klasik menunjukkan pukul 8:00 pagi dengan cahaya matahari pagi." },
            { k: "DARIPADA", m: "ORANG / BAHAN", e: "People / Material", f: "bahan-emas.jpg", p: "Foto dekat (close-up) sebilangan syiling emas dan cincin emas di atas permukaan kayu gelap." },
            { k: "KEPADA", m: "PENERIMA (Manusia)", e: "Recipient", f: "beri-surat.jpg", p: "Foto tangan seorang kanak-kanak menghulurkan sampul surat berwarna warni kepada rakannya." },
            { k: "PADA", m: "WAKTU / ABSTRAK", e: "Time / Abstract", f: "masa-jam.jpg", p: "Foto jam tangan moden yang elegan di atas meja kerja yang kemas." },
            { k: "SEJAK", m: "PERMULAAN MASA", e: "Since (Starting Time)", f: "sejak-kecil.jpg", p: "Foto hitam putih seorang bayi yang sedang merangkak di atas rumput, gaya nostalgia." },
            { k: "HINGGA", m: "HAD MASA / TEMPAT", e: "Until / Limit", f: "had-jalan.jpg", p: "Foto jalan raya yang panjang menuju ke ufuk matahari terbenam." },
            { k: "OLEH", m: "PELAKU (Ayat Pasif)", e: "By (Passive Actor)", f: "dimakan-ali.jpg", p: "Foto seorang budak lelaki sedang makan sebiji epal merah yang besar." },
            { k: "BAGI / UNTUK", m: "TUJUAN / KEGUNAAN", e: "Purpose", f: "tujuan-hadiah.jpg", p: "Foto kotak hadiah besar berikat reben merah di bawah pokok krismas." },
            { k: "TENTANG", m: "PERKARA / HAL", e: "About / Regarding", f: "tentang-buku.jpg", p: "Foto timbunan buku sejarah lama di atas meja kayu dengan cermin mata di atasnya." },
            { k: "TERHADAP", m: "SASARAN (Abstrak)", e: "Towards", f: "hormat-guru.jpg", p: "Foto siluet seorang pelajar sedang tunduk hormat kepada gurunya di hadapan kelas." }
        ];

        // --- DATA FASA 2 (5 Latihan Berstruktur) ---
        const p2Data = [
            { context: "Arah & Tujuan", s: "Kamal", v: "berbasikal", opts: ["di", "ke", "dari"], ans: "ke", o: "taman rekreasi.", eng: "Kamal cycles to the recreational park." },
            { context: "Lokasi Statik", s: "Buku rujukan itu", v: "tersusun", opts: ["di", "pada", "ke"], ans: "di", o: "atas rak kayu.", eng: "The reference book is arranged on the wooden shelf." },
            { context: "Tempat / Masa Asal", s: "Bas rombongan", v: "bertolak", opts: ["daripada", "dari", "kepada"], ans: "dari", o: "Kuala Lumpur.", eng: "The tour bus departed from Kuala Lumpur." },
            { context: "Sasaran Manusia", s: "Cikgu Adibah", v: "menyerahkan", opts: ["kepada", "pada", "untuk"], ans: "kepada", o: "ketua kelas.", eng: "Teacher Adibah handed (it) to the class monitor." },
            { context: "Sumber Bahan", s: "Pasu antik itu", v: "diperbuat", opts: ["dari", "daripada", "oleh"], ans: "daripada", o: "tanah liat.", eng: "The antique vase is made of clay." }
        ];
        let currP2Index = 0;

        // --- DATA FASA 3 (Chat) ---
        const chatScenarios = [
            { bot: "Salam! Awak berasal **dari** negeri mana?", target: "dari" },
            { bot: "Menarik! Hujung minggu ni awak nak berjalan **ke** mana?", target: "ke" },
            { bot: "Seronoknya. Baju lawa ni diperbuat **daripada** kain apa?", target: "daripada" },
            { bot: "Wah. Eh, buku ini awak nak hadiahkan **kepada** siapa?", target: "kepada" },
            { bot: "Terima kasih! Awak mula belajar di sekolah ni **sejak** bila?", target: "sejak" }
        ];
        let chatStage = 0;

        // --- INITIALIZE TEACHER SLIDES ---
        function initTeacherSlides() {
            const container = document.getElementById('teacherContainer');
            const monitorSlide = document.getElementById('tpLast');
            
            let slideIndex = 3; // Mulakan dari page 3 sebab page 1 (Tajuk) & page 2 (Do Now)
            
            notaKataSendi.forEach(nota => {
                const pg = document.createElement('div');
                pg.className = 'page';
                pg.id = `tp${slideIndex}`;
                pg.setAttribute('data-obj', `Penerangan: ${nota.k}`);
                
                // HTML baru yang mengandungi format auto-kesan untuk local folder
                pg.innerHTML = `
                    <div class="flex flex-col items-center justify-center mt-6 px-6 w-full">
                        <h2 class="text-giant-header text-indigo-600 mb-2">${nota.k}</h2>
                        <p class="text-giant-body mb-2">Untuk <strong>${nota.m}</strong></p>
                        <p class="text-dual mb-8">${nota.e}</p>
                        
                        <div class="w-full max-w-5xl mx-auto h-[380px] rounded-[32px] overflow-hidden shadow-2xl border-4 border-white relative group bg-slate-200 flex items-center justify-center">
                            <!-- Menggunakan nota.f (local file) terus -->
                            <img src="${nota.f}" alt="${nota.k}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.src='https://placehold.co/1000x500/e2e8f0/475569?text=Letak+Gambar+Sini:+${nota.f}'">
                            
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent"></div>
                            
                            <div class="absolute bottom-0 left-0 w-full p-8 text-white text-left">
                                <span class="inline-block bg-indigo-500 text-white text-[10px] font-black uppercase px-3 py-1 rounded-full mb-3 shadow-md tracking-widest">üì∏ Rujukan Visual Cikgu</span>
                                <p class="text-sm font-bold text-slate-300 mb-1">Nama Fail: ${nota.f}</p>
                                <p class="text-lg font-medium text-slate-100 leading-snug drop-shadow-md border-l-4 border-indigo-400 pl-4">Prompt: ${nota.p}</p>
                            </div>
                        </div>
                    </div>
                `;
                container.insertBefore(pg, monitorSlide);
                slideIndex++;
            });
            
            monitorSlide.id = `tp${slideIndex}`; // Update ID Live Monitor jadi yang terakhir
            totalTeacherPages = slideIndex; // Simpan total pages
            lucide.createIcons(); // Initialize icons
        }

        // Run initialization
        initTeacherSlides();

        // --- CORE FUNCTIONS ---
        function startApp(role) {
            studentName = document.getElementById('studentName').value.trim();
            if (role === 'student' && !studentName) return alert("Bro, isi nama dulu!");
            currentRole = role; 
            document.getElementById('view-landing').classList.remove('active');
            
            if(role === 'teacher') { 
                document.getElementById('view-teacher').classList.add('active'); 
                changeTeacherPage(0); // Load slide 1
            } else { 
                document.getElementById('view-student').classList.add('active'); 
                loadP2Question();
            }
        }

        // --- TEACHER VIEW FUNCTIONS ---
        function changeTeacherPage(d) {
            document.getElementById(`tp${tPage}`).classList.remove('active');
            tPage = Math.max(1, Math.min(totalTeacherPages, tPage + d)); 
            document.getElementById(`tp${tPage}`).classList.add('active');
            
            // Format Indicator (e.g., 01 / 15)
            const fmtT = tPage.toString().padStart(2, '0');
            const fmtTot = totalTeacherPages.toString().padStart(2, '0');
            document.getElementById('teacherIndicator').innerText = `${fmtT} / ${fmtTot}`;
            
            // Progress Bar (Teacher Mode)
            document.getElementById('progressFill').style.width = `${(tPage / totalTeacherPages) * 100}%`;

            if(tPage === totalTeacherPages) {
                document.getElementById('currentObjective').innerText = "Live Radar Fasa 2 & 3";
                startPolling();
            } else {
                // Update text kotak objektif berdasarkan attribute data-obj pada setiap slide
                const objText = document.getElementById(`tp${tPage}`).getAttribute('data-obj') || "Pengenalan Topik";
                document.getElementById('currentObjective').innerText = objText;
                stopPolling();
            }
        }
        function jumpToMonitor() { changeTeacherPage(totalTeacherPages - tPage); }

        // --- STUDENT VIEW FASA 2 FUNCTIONS ---
        function loadP2Question() {
            if(currP2Index >= p2Data.length) {
                goToPhase(3); // Masuk Sembang Santai
                return;
            }
            
            const q = p2Data[currP2Index];
            document.getElementById('p2Title').innerText = `Latihan ${currP2Index + 1} / 5`;
            document.getElementById('p2Context').innerText = `Konteks: ${q.context}`;
            
            document.getElementById('sSubject').innerText = q.s;
            document.getElementById('sVerb').innerText = q.v;
            document.getElementById('sObject').innerText = q.o;
            
            const sel = document.getElementById('sKsn');
            sel.innerHTML = '<option value="">(Pilih KSN)</option>';
            sel.classList.remove('correct');
            sel.disabled = false;
            
            // Randomize options
            let options = [...q.opts].sort(() => Math.random() - 0.5);
            options.forEach(opt => { sel.innerHTML += `<option value="${opt}">${opt}</option>`; });

            document.getElementById('stretchArea').classList.add('hidden');
            document.getElementById('translationInput').value = '';
        }

        function validateKsn() {
            const sel = document.getElementById('sKsn');
            const box = document.getElementById('legoBox');
            const val = sel.value;
            if(!val) return;

            if(val === p2Data[currP2Index].ans) {
                // Correct
                sel.classList.add('correct');
                sel.disabled = true;
                document.getElementById('stretchArea').classList.remove('hidden');
            } else {
                // Wrong! CFU Trigger
                box.classList.add('shake');
                sel.value = "";
                setTimeout(() => box.classList.remove('shake'), 400);
            }
        }

        async function submitP2Question() {
            const tr = document.getElementById('translationInput').value.trim();
            if(tr.length < 5) {
                document.getElementById('translationInput').classList.add('shake', 'border-red-500');
                setTimeout(() => document.getElementById('translationInput').classList.remove('shake', 'border-red-500'), 400);
                return;
            }

            const q = p2Data[currP2Index];
            const fullSentence = `${q.s} ${q.ans} ${q.o}`;
            
            // Highlight Star
            document.getElementById(`star-${currP2Index}`).classList.add('filled');
            
            // Ping to Live Monitor
            const progressStr = `Latihan ${currP2Index + 1}/5`;
            const payloadInfo = `Ayat: ${fullSentence} | BI: ${tr}`;
            pingDataLive('fasa2', payloadInfo, progressStr);

            currP2Index++;
            loadP2Question();
        }

        // --- STUDENT VIEW FASA 3 FUNCTIONS ---
        function initChat() { 
            document.getElementById('studentPhaseTitle').innerText = "Fasa 3: Sembang Santai";
            document.getElementById('chatArea').innerHTML = '';
            chatStage = 0; botReply(chatScenarios[0].bot); updateChatUI(); 
        }

        function updateChatUI() { 
            const s = chatScenarios[chatStage]; if(!s) return;
            document.getElementById('currentChatTag').innerText = s.target.toUpperCase();
            document.getElementById('chatProgressText').innerText = `${chatStage + 1} / ${chatScenarios.length}`;
        }

        function botReply(t) {
            const area = document.getElementById('chatArea');
            const b = document.createElement('div'); b.className = 'chat-bubble bubble-left'; b.innerHTML = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            area.appendChild(b); area.scrollTop = area.scrollHeight;
        }

        function handleChatInput() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim(); 
            if(!text) return;
            
            const s = chatScenarios[chatStage];
            
            // Validate if user used the target KSN
            if(!text.toLowerCase().includes(s.target.toLowerCase())) {
                 alert(`Misi Gagal: Anda wajib menggunakan perkataan '${s.target.toUpperCase()}' dalam ayat! Cuba lagi.`);
                 return;
            }

            const area = document.getElementById('chatArea');
            const b = document.createElement('div'); b.className = 'chat-bubble bubble-right'; b.innerText = text;
            area.appendChild(b); area.scrollTop = area.scrollHeight;
            input.value = '';

            // Ping Live Monitor!
            pingDataLive('fasa3', text, `Chat ${chatStage + 1}/${chatScenarios.length}`);

            chatStage++;
            setTimeout(() => {
                if(chatStage < chatScenarios.length) { botReply(chatScenarios[chatStage].bot); updateChatUI(); }
                else { 
                    botReply("Semua soalan selesai! Radar guru telah dikemaskini. üéØ"); 
                    document.getElementById('btnFinalSubmit').classList.remove('hidden'); 
                    document.querySelector('.bg-white.p-4.flex').style.display = 'none'; // Hide input box
                }
            }, 800);
        }

        function goToPhase(p) {
            document.querySelectorAll('.phase-container').forEach(el => el.classList.add('hidden'));
            document.getElementById(`phase${p}`).classList.remove('hidden');
            if(p === 3) initChat();
        }

        // --- BACKGROUND SYNCING TO GOOGLE SHEETS ---
        async function pingDataLive(type, info, progress) {
            try {
                // We send it asynchronously without waiting for UI to block
                fetch(SCRIPT_URL, { 
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({ nama: studentName, type: type, info: info, progress: progress }) 
                });
            } catch(e) { console.error("Gagal ping data", e); }
        }

        async function fetchLiveFeed() {
            try {
                const res = await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
                const data = await res.json();
                
                const gal = document.getElementById('liveGallery');
                gal.innerHTML = '';

                if(data.length === 0) {
                    gal.innerHTML = '<div class="text-center w-full col-span-full text-slate-400 font-bold mt-10">Belum ada respon pelajar.</div>';
                }

                data.reverse().forEach(r => {
                    const fasa2HTML = r.fasa2 ? `<div class="mb-3"><span class="text-xs font-black text-indigo-600">LATIHAN (FASA 2):</span><p class="text-sm bg-indigo-50 p-2 rounded whitespace-pre-line mt-1">${r.fasa2}</p></div>` : '';
                    const fasa3HTML = r.fasa3 ? `<div><span class="text-xs font-black text-green-600">SEMBANG (FASA 3):</span><p class="text-sm bg-green-50 p-2 rounded whitespace-pre-line mt-1">${r.fasa3}</p></div>` : '';
                    
                    gal.innerHTML += `
                        <div class="monitor-card flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <h4 class="font-black text-lg uppercase">${r.nama}</h4>
                                    <span class="text-[10px] bg-black text-white px-2 py-1 rounded-full">${r.progress}</span>
                                </div>
                                ${fasa2HTML}
                                ${fasa3HTML}
                            </div>
                            <div class="mt-4 text-right text-[10px] text-gray-400">Kemaskini terakhir: ${new Date(r.timestamp).toLocaleTimeString()}</div>
                        </div>
                    `;
                });

                document.getElementById('connectionDot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('lastSync').innerText = "Dikemaskini: " + new Date().toLocaleTimeString();
            } catch(e) { 
                document.getElementById('connectionDot').classList.replace('bg-green-500', 'bg-red-500'); 
            }
        }

        function startPolling() { stopPolling(); fetchLiveFeed(); pollingInterval = setInterval(fetchLiveFeed, 3000); }
        function stopPolling() { if(pollingInterval) clearInterval(pollingInterval); }

        async function hardResetData() {
            if(!confirm("Anda pasti mahu memadam SEMUA rekod radar pelajar?")) return;
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "reset" }) });
                alert("Kelas berjaya di-reset!");
                fetchLiveFeed();
            } catch(e) { alert("Ralat Reset!"); }
        }

        // --- KEYBOARD & SCROLL NAVIGATION ---
        document.addEventListener('keydown', (e) => {
            // Abaikan jika user tengah menaip dalam kotak input
            if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'textarea') return;

            // Tekan 'F' untuk Fullscreen
            if (e.key.toLowerCase() === 'f') {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => console.error("Fullscreen error", err));
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            }

            // Arrow Keys Navigasi (Hanya untuk Cikgu)
            if (currentRole === 'teacher') {
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') changeTeacherPage(1);
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') changeTeacherPage(-1);
            }
        });

        // Mouse Wheel Scrolling (Hanya untuk Cikgu)
        let isWheelScrolling = false;
        window.addEventListener('wheel', (e) => {
            if (currentRole !== 'teacher') return;
            
            // Benarkan native scroll kalau cikgu tengah scroll dalam Radar (live gallery)
            if (e.target.closest('#liveGallery') || e.target.closest('.overflow-y-auto')) return;

            if (isWheelScrolling) return;

            if (e.deltaY > 50) {
                changeTeacherPage(1);
                isWheelScrolling = true;
                setTimeout(() => isWheelScrolling = false, 600); // Debounce
            } else if (e.deltaY < -50) {
                changeTeacherPage(-1);
                isWheelScrolling = true;
                setTimeout(() => isWheelScrolling = false, 600); // Debounce
            }
        });

    </script>
</body>
</html>
